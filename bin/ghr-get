#!/usr/bin/env bash
set -eu

export VERSION=0.1.0
export BIN_PATH=$(dirname $(readlink -f "${BASH_SOURCE[0]}"))
export ROOT_PATH=$(dirname ${BIN_PATH})
export LIB_PATH=${ROOT_PATH}/lib

source ${LIB_PATH}/getoptions.sh

function parser_definition_main() {
  msg -- "ghr-get ${VERSION}"
  setup REST help:usage_main abbr:true width:20,20 -- \
      "Usage: ghr-get [global options...] [subcommand] [options...] [arguments...]"
  msg -- '' 'Global Options:'
  disp :usage_main -h --help -- "Show help"
  disp VERSION     --version -- "Show version"
  msg -- '' 'Subcommands:'
  cmd install         -- "Install package"
  cmd uninstall       -- "Uninstall package"
  cmd latest-version  -- "Show latest version"
}

function main() {
  eval "$(getoptions parser_definition_main parse_main) return 1"
  parse_main "$@"
  eval "set -- $REST"

  if [ $# -eq 0 ]; then
    usage_main
    return 0
  fi

  # check if the subcommand exists
  local -r subcommand=$1
  local -r subcommand_path="${LIB_PATH}/${subcommand}.sh"
  if [ ! -f ${subcommand_path} ]; then
    echo path=${subcommand_path}
    echo "Not a command: $subcommand" >&2
    return 1
  fi
  shift 1

  # execute subcommand
  source "${subcommand_path}"
  "$subcommand" "$@"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
